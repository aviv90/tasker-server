---
description: Always send errors to the client as-is, wherever they occur during command execution
globs:
  - "routes/whatsappRoutes.js"
  - "services/**"
---

# Error Handling: Send Errors to Client

## Core Principle

**Every error that occurs during command execution MUST be sent to the WhatsApp client as-is.**

The user should know when something goes wrong, not be left wondering why nothing happened.

## Implementation Pattern

### âœ… Correct Pattern

```javascript
try {
  const result = await someOperation();
  if (result.error) {
    await sendTextMessage(chatId, `âŒ ${result.error}`);
    return;
  }
  // Continue with success flow
} catch (error) {
  await sendTextMessage(chatId, `âŒ ×©×’×™××”: ${error.message}`);
  console.error('âŒ Detailed error for logs:', error);
  return;
}
```

### âŒ Incorrect - Silent failure

```javascript
try {
  const result = await someOperation();
  if (result.error) {
    console.error('Error occurred:', result.error);
    return; // User doesn't know what happened!
  }
} catch (error) {
  console.error('Error:', error);
  // Silent failure - user sees nothing
}
```

## Required in All Cases

1. **Service errors**
   ```javascript
   if (musicResult.error) {
     await sendTextMessage(chatId, `âŒ ${musicResult.error}`);
     return;
   }
   ```

2. **API call failures**
   ```javascript
   if (!generateResponse.ok) {
     await sendTextMessage(chatId, `âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ-API: ${generateData.msg}`);
     return;
   }
   ```

3. **Validation errors**
   ```javascript
   if (!prompt || prompt.trim().length === 0) {
     await sendTextMessage(chatId, 'âŒ ×× × ×¡×¤×§ prompt ×œ×¤×§×•×“×”');
     return;
   }
   ```

4. **Unexpected exceptions**
   ```javascript
   } catch (error) {
     await sendTextMessage(chatId, `âŒ ×©×’×™××” ×‘×œ×ª×™ ×¦×¤×•×™×”: ${error.message}`);
     console.error('Full error:', error);
   }
   ```

## Error Message Guidelines

1. **Hebrew for user-facing messages** (this is a Hebrew bot)
   - `âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×©×™×¨`
   - `âš ï¸ ×”×§×•×‘×¥ ×’×“×•×œ ××“×™`
   - `ğŸ”„ × ×™×¡×™×•×Ÿ × ×•×¡×£...`

2. **Include the actual error** when possible
   - `âŒ ${result.error}` - passes through API errors
   - `âŒ ×©×’×™××”: ${error.message}` - includes exception message

3. **Be specific** about what failed
   - âœ… `âŒ ×©×’×™××” ×‘×”×•×¨×“×ª ×”×•×™×“××•: HTTP 404`
   - âŒ `âŒ ×©×’×™××”` (too vague)

## Examples from Codebase

### Music Generation
```javascript
const musicResult = await generateMusicWithLyrics(prompt, options);
if (musicResult.error) {
  await sendTextMessage(chatId, `âŒ ${musicResult.error}`);
} else if (musicResult.message) {
  await sendTextMessage(chatId, musicResult.message);
}
```

### Video Generation
```javascript
if (videoResult.error) {
  console.error(`âŒ Failed to start video generation:`, videoResult.error);
  if (taskInfo.whatsappContext) {
    const { sendTextMessage } = require('../services/greenApiService');
    await sendTextMessage(
      taskInfo.whatsappContext.chatId, 
      `âš ï¸ ×”×©×™×¨ × ×•×¦×¨ ××‘×œ ×”×™×™×ª×” ×‘×¢×™×” ×‘×™×¦×™×¨×ª ×”×•×™×“××•: ${videoResult.error}`
    );
  }
}
```

## Remember

- **Logging is not enough** - the user can't see console logs
- **Don't swallow errors** - even if you handle them, tell the user
- **Fail visibly** - better to show an error than to fail silently
