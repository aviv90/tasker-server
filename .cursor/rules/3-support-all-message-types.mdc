---
description: Support all message and media types in conversation history and quoted messages
globs:
  - "routes/whatsappRoutes.js"
  - "services/agentService.js"
  - "services/agentPilot.js"
---

# Support All Message & Media Types

## Core Requirement

**The Agent must understand and process all types of messages and media:**

1. âœ… **All media types** in conversation history (images, videos, audio, polls)
2. âœ… **Quoted/replied messages** with proper context passing
3. âœ… **Both incoming and outgoing** message flows

---

## 1ï¸âƒ£ Media Types in Conversation History

When saving messages to history, always include media indicators:

```javascript
// âœ… Correct - in routes/whatsappRoutes.js
if (hasImage) {
  botMessageContent = `[×ª××•× ×” ××¦×•×¨×¤×ª]\n${botResponse}`;
} else if (hasVideo) {
  botMessageContent = `[×•×™×“××• ××¦×•×¨×£]\n${botResponse}`;
} else if (hasAudio) {
  botMessageContent = `[×”×§×œ×˜×” ×§×•×œ×™×ª]`;
}
```

**Supported media types:**
- ğŸ–¼ï¸ Images: `[×ª××•× ×” ××¦×•×¨×¤×ª]`
- ğŸ¬ Videos: `[×•×™×“××• ××¦×•×¨×£]`
- ğŸ¤ Audio: `[×”×§×œ×˜×” ×§×•×œ×™×ª]`
- ğŸ“Š Polls: `[×¡×§×¨]`
- ğŸ“ Location: `[××™×§×•×]`

---

## 2ï¸âƒ£ Quoted Messages Support

Quoted messages must pass full context to the Agent:

```javascript
// âœ… Correct - in routes/whatsappRoutes.js
let quotedContext = null;
if (isActualQuote && quotedMessage) {
  quotedContext = {
    type: quotedMessage.typeMessage || 'unknown',
    text: quotedMessage.textMessage || quotedMessage.caption || '',
    hasImage: quotedMessage.typeMessage === 'imageMessage',
    hasVideo: quotedMessage.typeMessage === 'videoMessage',
    hasAudio: quotedMessage.typeMessage === 'audioMessage',
    stanzaId: quotedMessage.stanzaId
  };
}

const normalized = {
  userText: `# ${finalPrompt}`,
  quotedContext: quotedContext, // â† Pass to Agent
  // ...
};
```

**Then in agentPilot.js:**
```javascript
if (input.quotedContext) {
  contextualPrompt = `[×”×•×“×¢×” ××¦×•×˜×˜×ª: ${input.quotedContext.type}]\n${input.quotedContext.text}\n\n[×‘×§×©×” × ×•×›×—×™×ª:]\n${userText}`;
}
```

---

## 3ï¸âƒ£ Agent Tools Must Handle Media

When creating tools in `agentService.js`, consider media context:

```javascript
// Example: analyze_image_from_history tool
analyze_image_from_history: {
  declaration: {
    name: 'analyze_image_from_history',
    description: '× ×ª×— ×ª××•× ×” ×©×”××©×ª××© ×©×œ×— ×§×•×“× (××”×”×™×¡×˜×•×¨×™×”)'
    // ...
  },
  execute: async (args, context) => {
    // Get history first
    const history = context.previousToolResults?.get_chat_history?.messages;
    // Find image by ID
    const imageMsg = history[args.image_id];
    // Download and analyze
    // ...
  }
}
```

---

## 4ï¸âƒ£ Testing Checklist

When adding media support or quoted message handling:

- [ ] Test with image attachment
- [ ] Test with video attachment
- [ ] Test with audio message
- [ ] Test with quoted text message
- [ ] Test with quoted image
- [ ] Test with quoted video
- [ ] Verify media appears in conversation history correctly
- [ ] Verify Agent can access media from history

---

## Examples

### âœ… Correct: Media in History
```javascript
await conversationManager.addMessage(chatId, 'assistant', botMessageContent, {
  hasImage: !!imageUrl,
  hasVideo: !!videoUrl,
  hasAudio: !!audioUrl,
  imageUrl: imageUrl,
  videoUrl: videoUrl
});
```

### âœ… Correct: Quoted Context Passing
```javascript
// routes/whatsappRoutes.js
const normalized = {
  userText: prompt,
  quotedContext: {
    type: 'imageMessage',
    text: '×ª××•× ×ª ×—×ª×•×œ',
    hasImage: true,
    stanzaId: 'ABC123'
  }
};

// agentPilot.js receives and uses it
if (input.quotedContext?.hasImage) {
  contextualPrompt = `[×”×•×“×¢×” ××¦×•×˜×˜×ª: ×ª××•× ×”]\n...\n\n[×‘×§×©×”:]\n${userText}`;
}
```

---

## Remember

- **All media types** must be logged in history
- **Quoted messages** need full context (type, text, media flags)
- **Agent tools** should be able to access historical media
- **Test thoroughly** - media handling is critical for user experience
