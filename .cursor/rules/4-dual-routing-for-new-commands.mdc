---
description: ×›×œ ×¤×§×•×“×” ×—×“×©×” ×¦×¨×™×›×” ×œ×¢×‘×•×“ ×¢× Regex ×•×’× ×¢× LLM routing
---

# Dual Routing for New Commands

×›×œ ×¤×§×•×“×” ×—×“×©×” ×©××ª×•×•×¡×¤×ª ×œ×‘×•×˜ (×©××™× ×” ×¤×§×•×“×ª × ×™×”×•×œ) **×—×™×™×‘×ª** ×œ×”×™×•×ª ××–×•×”×” ×‘×©× ×™ ××¡×œ×•×œ×™ ×”×–×™×”×•×™:

## 1ï¸âƒ£ Regex Heuristic (×›×©-`INTENT_ROUTER_USE_LLM` ×›×‘×•×™)

×‘××§×˜×¢ ×”-regex ×©×œ `services/intentRouter.js` (×©×•×¨×•×ª ~56-276), ×™×© ×œ×”×•×¡×™×£:

```javascript
const isNewCommand = /pattern1|pattern2|keyword1|keyword2/i.test(prompt);
```

**×—×•×‘×”:**
- âœ… ×›×œ ×”×•×•×¨×™××¦×™×•×ª ×”×¨×œ×•×•× ×˜×™×•×ª (×¢×‘×¨×™×ª **×•**×× ×’×œ×™×ª)
- âœ… Case-insensitive (`/i` flag)
- âœ… ×›×™×¡×•×™ ×›×œ ××™×œ×•×ª ×”××¤×ª×—

**×“×•×’××”:**
```javascript
const isPoll = /×¦×•×¨.*×¡×§×¨|×™×¦×™×¨×ª.*×¡×§×¨|×¡×§×¨.*×¢×œ|create.*poll|make.*poll|poll.*about/i.test(prompt);
```

---

## 2ï¸âƒ£ LLM Prompt (×›×©-`INTENT_ROUTER_USE_LLM='on'`)

×‘×¤×•× ×§×¦×™×” `buildRouterPrompt()` (×©×•×¨×•×ª ~396+), ×™×© ×œ×”×•×¡×™×£:

### ×. ×”×¡×‘×¨ ×‘×¡×¢×™×£ ×”×¨×œ×•×•× ×˜×™
```
ğŸ”¹ **New Command:**
   Keywords: "keyword1", "keyword2", "××™×œ×”1", "××™×œ×”2"
   â†’ "new_command_tool"
```

### ×‘. ×“×•×’×××•×ª ×‘×¡×¢×™×£ EXAMPLES
```javascript
Input: {"userText": "# keyword example", ...}
Output: {"tool": "new_command_tool", "args": {"prompt": "..."}, "reason": "..."}

Input: {"userText": "# ×“×•×’××” ×‘×¢×‘×¨×™×ª", ...}
Output: {"tool": "new_command_tool", "args": {"prompt": "..."}, "reason": "..."}
```

### ×’. ×”×•×¡×¤×ª ×”×›×œ×™ ×œ×¨×©×™××”
```javascript
âš™ï¸ AVAILABLE TOOLS:
gemini_chat, ..., new_command_tool, ...
```

---

## 3ï¸âƒ£ Validation

×”×•×¡×£ ××ª ×”×›×œ×™ ×œ-`allowedTools` ×‘×¤×•× ×§×¦×™×” `validateDecision()`:

```javascript
const allowedTools = new Set([
  'gemini_image', ..., 'new_command_tool', ...
]);
```

---

## âœ… **×œ××” ×–×” ×—×©×•×‘?**

×–×” ××‘×˜×™×— ×©:
- âœ… ×”×¤×§×•×“×” ×ª×¢×‘×•×“ **×‘×›×œ ×”×ª×¦×•×¨×•×ª**
- âœ… ×ª××™×›×” **×‘×©×ª×™ ×”×©×¤×•×ª** (×¢×‘×¨×™×ª + ×× ×’×œ×™×ª)
- âœ… **Consistency** - ××•×ª×” ×”×ª× ×”×’×•×ª ×¢×/×‘×œ×™ LLM
- âœ… **Fallback** - ×× LLM × ×›×©×œ, Regex ×ª×•×¤×¡

---

## ğŸ“‚ **×§×‘×¦×™× ×œ×¢×“×›×Ÿ:**

1. `services/intentRouter.js` - regex patterns
2. `services/intentRouter.js` - `buildRouterPrompt()` function
3. `services/intentRouter.js` - `allowedTools` set
