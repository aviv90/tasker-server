---
description: The Agent must support retry functionality with modifications
globs:
  - "services/agentService.js"
  - "services/agentPilot.js"
---

# Agent Retry Support

The Agent must support **retry functionality** - allowing users to retry previous commands with optional modifications.

---

## ğŸ“‹ Core Requirements

### 1ï¸âƒ£ **Automatic Command Saving**

`agentPilot.js` must automatically save successful commands:

```javascript
// âœ… Correct - in services/agentPilot.js
if (agentResult.success && agentResult.toolsUsed && agentResult.toolsUsed.length > 0) {
  const primaryTool = agentResult.toolsUsed[0];
  
  await conversationManager.saveLastCommand(chatId, primaryTool, {
    prompt: userText,
  }, {
    normalized: input
  });
  
  console.log(`ğŸ’¾ [PILOT] Saved last command for retry: ${primaryTool}`);
}
```

**When?** After every successful Agent execution.

---

### 2ï¸âƒ£ **retry_last_command Tool**

The Agent must have a `retry_last_command` tool that:

```javascript
// âœ… Correct - in services/agentService.js
retry_last_command: {
  declaration: {
    name: 'retry_last_command',
    description: '×—×–×•×¨ ×¢×œ ×”×¤×§×•×“×” ×”××—×¨×•× ×”, ×¢× ××¤×©×¨×•×ª ×œ×©× ×•×ª ×¡×¤×§ ××• ×¤×¨××˜×¨×™×',
    parameters: {
      provider_override: 'gemini|openai|grok|...',
      modifications: '×©×™× ×•×™×™× × ×•×¡×¤×™×'
    }
  },
  execute: async (args, context) => {
    // Get last command from DB
    const lastCommand = await conversationManager.getLastCommand(chatId);
    
    // Apply modifications
    let modifiedPrompt = originalArgs.prompt;
    if (args.modifications) {
      modifiedPrompt = `${originalArgs.prompt}, ${args.modifications}`;
    }
    
    // Retry with new provider if specified
    const provider = args.provider_override || originalArgs.provider;
    // ...
  }
}
```

---

### 3ï¸âƒ£ **Support for Modifications**

The `retry_last_command` tool supports several scenarios:

#### **Scenario A: Simple Retry**
```
User: # ×¦×•×¨ ×ª××•× ×” ×©×œ ×—×ª×•×œ
â†’ [fails]
User: # × ×¡×” ×©×•×‘
â†’ âœ… Agent calls retry_last_command() â†’ retries same command
```

#### **Scenario B: Retry with Provider Change**
```
User: # ×¦×•×¨ ×ª××•× ×” ×©×œ ×“×•×‘
â†’ [created with Gemini]
User: # ×©×•×‘ ×¢× OpenAI
â†’ âœ… Agent calls retry_last_command(provider_override='openai')
```

#### **Scenario C: Retry with Modifications**
```
User: # ×¦×•×¨ ×ª××•× ×” ×©×œ ×›×œ×‘
â†’ [success]
User: # × ×¡×” ×©×•×‘, ××‘×œ ×¢× ×©×™×¢×¨ ××¨×•×š
â†’ âœ… Agent calls retry_last_command(modifications='×¢× ×©×™×¢×¨ ××¨×•×š')
â†’ Executes: "×¦×•×¨ ×ª××•× ×” ×©×œ ×›×œ×‘, ×¢× ×©×™×¢×¨ ××¨×•×š"
```

---

## 4ï¸âƒ£ **System Prompt Must Guide Retry Usage**

The Agent's system prompt must include clear instructions:

```
ğŸ” **××ª×™ ×œ×”×©×ª××© ×‘-retry:**
â€¢ "× ×¡×” ×©×•×‘" / "×©×•×‘" / "×¢×•×“ ×¤×¢×" â†’ retry_last_command
â€¢ "×¢× OpenAI" / "×¢× Gemini" â†’ retry_last_command (×¢× provider_override)
â€¢ "××‘×œ ×¢× X" / "×ª×§×Ÿ ×œ-Y" â†’ retry_last_command (×¢× modifications)
```

This ensures the Agent knows when to use the retry tool.

---

## âœ… Implementation Checklist

When working with retry functionality:

- [ ] `agentPilot.js` saves commands after successful execution
- [ ] `retry_last_command` tool exists in `agentService.js`
- [ ] Tool supports `provider_override` parameter
- [ ] Tool supports `modifications` parameter
- [ ] System prompt guides Agent on when to use retry
- [ ] Test: Simple retry ("× ×¡×” ×©×•×‘")
- [ ] Test: Retry with provider change ("×¢× OpenAI")
- [ ] Test: Retry with modifications ("××‘×œ ×¢× X")

---

## ğŸ¯ Goal

Provide a user experience similar to **ChatGPT/Claude** where users can always:
- "× ×¡×” ×©×•×‘" (try again)
- "×©×•×‘ ××‘×œ ×¢× X" (again but with X)
- "×¢× ×¡×¤×§ ××—×¨" (with different provider)

This allows users to **iterate and improve** results easily! ğŸš€

---

## Key Differences from Old Architecture

### Old (Switch Cases):
- Manual `saveLastCommand()` call in every case
- Duplicated across incoming/outgoing handlers
- Easy to forget

### New (Agent):
- Automatic saving in `agentPilot.js`
- Single point of implementation
- Hard to forget - it's centralized

The Agent architecture makes retry support **more reliable** and **easier to maintain**.
